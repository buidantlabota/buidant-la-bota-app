name: Backup Total Supabase

on:
  schedule:
    # S'executa el dia 1 de cada mes a les 05:00 AM UTC
    - cron: '0 5 1 * *'
  workflow_dispatch: # Permet l'execució manual per fer proves

jobs:
  run-backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install resend

      - name: Install PostgreSQL client and DNS tools
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client dnsutils

      - name: Disable IPv6 (Force IPv4)
        run: |
          # Aquesta és la solució radical: desactivem IPv6 a tot el servidor de GitHub
          # Això obliga a pg_dump a trobar el camí IPv4 sí o sí.
          sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
          sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
          sudo sysctl -w net.ipv6.conf.lo.disable_ipv6=1

      - name: Generate SQL Dump and ZIP
        env:
          DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          PROJECT_REF="nkkekyhtybfheqjtxlgx"
          DATE=$(date +%Y-%m-%d)
          SQL_FILE="backup_total_${DATE}.sql"
          ZIP_FILE="backup_buidantlabota_${DATE}.zip"
          HOSTNAME="db.${PROJECT_REF}.supabase.co"
          
          echo "Resolent IP (forçant IPv4)..."
          # Busquem la IP numèrica per assegurar que no intenti anar per la ruta fallida
          IPV4=$(getent ahosts $HOSTNAME | grep RAW | grep -v : | awk '{print $1}' | head -n1)
          echo "IPv4 resolta: $IPV4"

          # Si per algun motiu no troba IP, usarem el host normal (pero amb IPv6 desactivat)
          TARGET_HOST=${IPV4:-$HOSTNAME}
          
          # Codifiquem la contrasenya
          ENCODED_PW=$(node -e "console.log(encodeURIComponent(process.env.DB_PASSWORD))")
          
          # URL de connexió al port 6543 (Pooler) que suporta IPv4 perfectament
          # Si usem la IP al hostaddr, mantenim l'SNI (SSL) pel hostname
          DB_URL="postgresql://postgres.${PROJECT_REF}:${ENCODED_PW}@${HOSTNAME}:6543/postgres?hostaddr=${TARGET_HOST}"
          
          echo "Generant dump SQL directament..."
          pg_dump "$DB_URL" --no-owner --no-acl > $SQL_FILE
          
          echo "Comprimint en ZIP..."
          zip $ZIP_FILE $SQL_FILE
          
          # Guardem el nom del fitxer per al següent pas
          echo "BACKUP_FILENAME=$ZIP_FILE" >> $GITHUB_ENV

      - name: Send Email with Backup
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          node scripts/send-backup-email.js $BACKUP_FILENAME
